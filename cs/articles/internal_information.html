<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html class="theme-dark">
  
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Internal information </title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="title" content="Internal information ">
    <meta name="generator" content="docfx 2.58.0.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.2/jquery.modal.min.css" integrity="sha512-T3VL1q6jMUIzGLRB9z86oJg9PgF7A55eC2XkB93zyWSqQw3Ju+6IEJZYBfT7E9wOHM7HCMCOZSpcssxnUn6AeQ==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/stackoverflow-dark.min.css" integrity="sha512-Xn1b0y/BrCD7usnEh6r9CcKxHXFVleVUjGDnfc95zDDwFUwtOz3lJC/XtJcuLRNyrMQJEEToFfwjC9Ue/aWY/g==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/stackoverflow-light.min.css" integrity="sha512-RDtnAhiPytLVV3AwzHkGVMVI4szjtSjxxyhDaH3gqdHPIw5qwQld1MVGuMu1EYoof+CaEccrO3zUVb13hQFU/A==" crossorigin="anonymous" disabled="disabled">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/solid.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="../../styles/colors.css">
    <link rel="stylesheet" href="../../styles/discord.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>

  <body>

        <div class="body-content">

            <nav id="sidebar" role="navigation">

                <div class="sidebar">
                    
                    
                    
                    
                    <div>
                      
                      <a class="brand" href="../../index.html">
                        <img src="../../logo.svg" alt="alt:V" class="logomark">
                        <span class="brand-title">alt:V</span>
                      </a>
                      <div id="navbar">
                    
                      </div>
                    
                    </div>
                    


                </div>


            </nav>

            <main class="main-panel">

                <div class="blackout desktop-hide"></div>

                    
                    <div class="subnav navbar navbar-default">
                      <button class="btn-link search-back desktop-hide"></button>
                      <button class="btn-link navbar-toggler" aria-label="Toggle navigation"></button>
                      <div class="container" id="breadcrumb">
                        <ul class="breadcrumb">
                          <li></li>
                        </ul>
                      </div>
                      <div class="flex-space"></div>
                      <div class="toolbar">
                          <div style="position: relative; margin: 0 8px;">
                            <form class="search-bar mobile-hide" role="search" id="search" style="position: relative;">
                              <button class="btn-link clear" id="search-query-clear"></button>
                              <div role="textbox" class="form-control" id="search-query" placeholder="Search" contenteditable="true"></div>
                            </form>
                            <div class="popout" id="search-menu">
                                <button class="btn-link search-help" data-href="../../articles/search_help.html"></button>
                              <span class="title">
                                Search options:
                              </span>
                            </div>
                            <button class="btn-link search-tip desktop-hide"></button>
                          </div>
                      </div>
                      <button class="btn-link btn-floating search desktop-hide"></button>
                      <div class="theme">
                        <button class="btn-link theme" aria-label="Switch theme"></button>
                        <div class="popout" id="theme-menu">
                          <div class="theme-option light" data-theme="light">
                            <span class="btn-link theme-light">Light</span>
                          </div>
                          <div class="theme-option dark" data-theme="dark">
                            <span class="btn-link theme-dark">Dark</span>
                          </div>
                          <div class="theme-option auto" data-theme="auto">
                            <span class="btn-link theme-auto">Sync with OS</span>
                          </div>
                        </div>
                      </div>
                    </div>

                <div class="content-region" role="main">

                    <div class="content-column Conceptual">

                            
                            <div class="sideaffix hide-when-search" data-noindex="">
                              <h3>Index</h3>
                              <div class="bs-docs-sidebar affix" id="affix"><ul class="level1 nav bs-docs-sidenav"><li><a href="#internal-information">Internal information</a><ul class="level2 nav bs-docs-sidenav internal-information"><li><a href="#initialization-of-csharp-module">Initialization of csharp-module</a></li><li><a href="#loading-a-resource">Loading a resource</a></li><li><a href="#executing-commands">Executing commands</a></li><li><a href="#receiving-events">Receiving events</a></li></ul></li></ul></div>
                            </div>

                            
                            <div id="search-results">
                              <div class="search-list">Search Results for <span></span></div>
                              <div class="sr-items">
                                <p><span class="glyphicon glyphicon-refresh index-loading"></span></p>
                              </div>
                              <ul id="pagination" data-first="" data-prev="&#xf053;" data-next="&#xf054;" data-last=""></ul>
                            </div>

                        <article class="content wrap hide-when-search" id="_content" data-uid="">

                                <span class="small pull-right article mobile-hide" style="margin: 0;" data-noindex="">
                                    <ul class="subnav contribution">
                                            <li>
                                                <a href="https://github.com/FabianTerhorst/coreclr-module/blob/master/docs/articles/internal_information.md/#L1">Improve this Doc</a>
                                            </li>
                                    </ul>
                                </span>

<h1 id="internal-information">Internal information</h1>

<p>This section provides a high-level overview about the internal structure of the C# module and how it's playing together with the AltV server.</p>
<div class="WARNING">
  <h6>Important</h6>
  <p>Resource developers don't need to know the internal structure, but it is helpful sometimes. This is mainly for developers who like to contribute to the C# module.</p>
</div>
<h2 id="initialization-of-csharp-module">Initialization of csharp-module</h2>
<p>When the <code>altv-server</code> is starting it checks <code>modules</code> part of the <code>server.cfg</code> configuration file. When there's the csharp-module specified, the server loads the &quot;csharp-module.dll&quot; / &quot;libcsharp-module.so&quot; / &quot;csharp-module.so&quot; (depending on operating system) from the <code>modules</code> folder.</p>
<p>In the csharp-module is a function <a href="https://github.com/FabianTerhorst/coreclr-module/blob/master/runtime/src/altv.cpp"><code>altMain</code></a> defined, which starts the .NET runtime and registers itself as script runtime for <code>csharp</code> resources. That's the reason you have to specify <code>type: csharp</code> in the <code>resource.cfg</code>, so the altv-server knows that it should load this resource with the csharp-module.</p>
<p>The <a href="https://github.com/FabianTerhorst/coreclr-module/blob/master/runtime/src/CoreClr.cpp">custom .NET host</a> tries to find the latest .NET SDK <code>hostfxr.dll</code> (example path on Windows is <code>C:\Program Files (x86)\dotnet\host\fxr\5.0.1\hostfxr.dll</code>). When it's found, it starts <code>AltV.Net.Host.dll</code> which is located next to the <code>altv-server</code>.</p>
<p>Now in .NET world the <a href="https://github.com/FabianTerhorst/coreclr-module/tree/master/api/AltV.Net.Host"><code>AltV.Net.Host</code></a> first initialize some delegates which can be triggered from the <code>csharp-module</code>. For example the <code>csharp-module</code> can trigger a delegate to start a specific resource with a name, path and a main file.</p>
<p>The main initialization is now done and we are waiting until a resource of type <code>csharp</code> should be loaded.</p>
<p>Summary:</p>
<ul>
<li><code>altv-server</code> calls platform dependent csharp-module</li>
<li><code>csharp-module</code> acts as custom .NET host, starts .NET runtime with <code>AltV.Net.Host.dll</code></li>
<li><code>AltV.Net.Host</code> initializes delegates which can be executed from <code>csharp-module</code></li>
</ul>
<h2 id="loading-a-resource">Loading a resource</h2>
<p>For every C# resource the <code>csharp-module</code> creates a <a href="https://github.com/FabianTerhorst/coreclr-module/blob/master/runtime/src/CSharpResourceImpl.cpp"><code>CSharpResourceImpl</code></a>. When the resource is started by the server, the class triggers <code>AltV.Net.Host</code> with the previous initialized <code>ExecuteResource</code> delegate.</p>
<p>There a <a href="https://github.com/FabianTerhorst/coreclr-module/blob/master/api/AltV.Net.Host/ResourceAssemblyLoadContext.cs">custom</a> <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.loader.assemblyloadcontext"><code>AssemblyLoadContext</code></a> is created, which is responsible for loading and resolving assemblies like the resource and their dependencies. The load context loads the files just from the resource folder which it is created for and is isolated from other resources.</p>
<p>In the end the resource assembly is loaded and the <code>AltV.Net.dll</code> assembly is initialized by calling the <a href="https://github.com/FabianTerhorst/coreclr-module/blob/master/api/AltV.Net/ModuleWrapper.cs"><code>ModuleWrapper#MainWithAssembly</code></a> among others.</p>
<p>Here the main initialization happens: The entity factories are resolved which are needed for creating the entity pools. These entity pools are storing the active entities like for example currently connected players in the player pool.</p>
<p>In order to receive events later from the server, it's required to set delegates which are executed on the <code>csharp-module</code>. This is done in <a href="https://github.com/FabianTerhorst/coreclr-module/blob/master/api/AltV.Net/CSharpResourceImpl.cs"><code>CSharpResourceImpl</code></a> from <code>AltV.Net</code> assembly. The functions which are executed are in <code>ModuleWrapper</code> and there the module functions are triggered.</p>
<p>Depending if the resource derives from <code>Resource</code> or <code>AsyncResource</code> a different module is resolved. The <code>AsyncModule</code> is thereby derived from <code>Module</code>. The module is the main class which stores all entity pools, forwards events to <code>IScript</code> methods and the event handlers in resources, like <code>Alt.OnPlayerEnterVehicle</code> and so on.</p>
<p>Afterwards the load context will be searched for implementations of <code>IScript</code>. These classes can have methods with custom attributes like <code>ScriptEventAttribute</code>. When specified for example <code>ScriptEventType.PlayerConnect</code> this method will be called every time a player connects. In order to get that working every <code>IScript</code> is loaded and the events registered. There are simply the <code>Alt.On*</code> events used (for non-async attributes). For <code>PlayerConnect</code>, there is an event handler for <code>Alt.OnPlayerConnect</code> which triggers the <code>IScript</code> method.</p>
<p>Last but not least the <code>csharp-module</code> is now triggering the <code>MainDelegate</code> which is received in the <code>ModuleWrapper</code>. There it just execute the <code>OnStart</code> method of the resource. This <code>OnStart</code> has every resource implemented, as it is a abstract method on the <a href="https://github.com/FabianTerhorst/coreclr-module/blob/master/api/AltV.Net/Resource.cs"><code>Resource</code></a> class.</p>
<p>Summary:</p>
<ul>
<li><code>altv-server</code> calls <code>csharp-module</code> to start resource</li>
<li><code>csharp-module</code> creates <code>CSharpResourceImpl</code> which triggers <code>AltV.Net.Host</code></li>
<li><code>AltV.Net.Host</code> loads resource assembly and dependencies (with <code>AltV.Net</code>)</li>
<li><code>AltV.Net</code> initializes itself and resource</li>
<li><code>csharp-module</code> triggers <code>MainDelegate</code> which executes resource <code>OnStart</code></li>
</ul>
<h2 id="executing-commands">Executing commands</h2>
<p>When executing a command like <code>Alt.CreateVehicle</code> the static <code>Alt</code> class is just a proxy for internal methods. In the end it will trigger most likely a method inside of <a href="https://github.com/FabianTerhorst/coreclr-module/tree/master/api/AltV.Net/Native"><code>AltNative</code></a>. This is a partial class (multiple files which are combined to one class) and acts as thin wrapper for the <code>csharp-module</code>.</p>
<p>In the vehicle example <code>AltNative.Server_CreateVehicle</code> is executed, which is a exported function in the <code>csharp-module</code>. The <code>Alt.Net</code> assembly uses the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.dllimportattribute"><code>DllImportAttribute</code></a> to call the method from the native library.</p>
<p>Inside of the <code>csharp-module</code> the data is copied to internal data structures and then send to the <code>altv-server</code>.</p>
<h2 id="receiving-events">Receiving events</h2>
<p>The events are received in the <code>csharp-module</code>. Every resource receives most of the events in <code>CSharpResourceImpl::OnEvent</code>. This prepares the data and executes a method of the <code>ModuleWrapper</code> with a delegate previous set in the initialization.</p>
<p>For example for the <code>alt::CEvent::Type::PLAYER_ENTER_VEHICLE</code> the required data is retrieved from the event and <code>OnPlayerEnterVehicleDelegate</code> is executed. This delegate is part of <code>ModuleWrapper</code> and there directly the <code>OnPlayerEnterVehicle</code> method of the loaded module is executed.</p>
<p>From there the entites are checked if these are valid and exists on the server. In the end all registered event handler are executed, like <code>Alt.OnPlayerEnterVehicle</code> or <code>ScriptEventAttribute</code>.</p>
</article>
                    </div>

                </div>

            </main>

        </div>

        
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/arrive/2.4.1/arrive.min.js" integrity="sha512-wkU3qYWjenbM+t2cmvw2ADRRh4opbOYBjkhrPGHV7M6dcE/TR0oKpoDkWXfUs3HrulI2JFuTQyqPLRih1V54EQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twbs-pagination/1.4.2/jquery.twbsPagination.min.js" integrity="sha512-frFP3ZxLshB4CErXkPVEXnd5ingvYYtYhE5qllGdZmcOlRKNEPbufyupfdSTNmoF5ICaQNO6SenXzOZvoGkiIA==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.2/jquery.modal.min.js" integrity="sha512-ztxZscxb55lKL+xmWGZEbBHekIzy+1qYKHGZTWZYH1GUwxy0hiA18lW6ORIMj4DHRgvmP/qGcvqwEyFFV7OYVQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.0/anchor.min.js" integrity="sha512-G2OGlm41XXw+fcgDcRPjVYEn7qCY6qiKWNqDGT37SnKh0qtRXTuKZ5/UQR0kDN0PZRNWcGExd3lAeqEH0I36bQ==" crossorigin="anonymous"></script>
<script type="text/javascript" src="../../styles/docfx.js"></script>
<script type="text/javascript" src="../../styles/discord.js"></script>
<script type="text/javascript" src="../../styles/main.js"></script>

    </body>

</html>
